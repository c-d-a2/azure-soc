{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "## BruteForceAttempts STATS\n"
      },
      "name": "text - 2",
      "id": "b93742bf-8d50-4b77-b2fe-044150c5075e"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let winThreshold = 10;   \nlet sshThreshold = 10;    \nlet lookback = 24h;        \n\n\nlet WindowsFailures = \n    SecurityEvent\n    | where EventID == 4625 \n    | where TimeGenerated > ago(lookback)\n    | summarize Attempts = count()\n        by SrcIP = tostring(IpAddress), TimeBucket = bin(TimeGenerated, 1h),HostName = Computer\n    | where Attempts >= winThreshold\n    ;\n\nlet IpRegex = @\"\\b\\d{1,3}(\\.\\d{1,3}){3}\\b\";\nlet SSHFailures =\n    Syslog\n    | where Facility == \"auth\" and SyslogMessage startswith \"Failed password for\"\n    | where TimeGenerated > ago(lookback)\n    | extend SrcIP = extract(IpRegex, 0, SyslogMessage)\n    | summarize Attempts = count()\n        by SrcIP, TimeBucket = bin(TimeGenerated, 1h), HostName\n    | where Attempts >= sshThreshold\n    ;\n\nunion WindowsFailures, SSHFailures\n| extend Geo = geo_info_from_ip_address(SrcIP)\n| project \n    TimeBucket,\n    SrcIP,\n    Attempts,\n    HostName,\n    Country   = Geo.country,\n    Region    = Geo.state,\n    City      = Geo.city,\n    Latitude  = Geo.latitude,\n    Longitude = Geo.longitude",
        "size": 0,
        "title": "BruteForceAttemptsHeatMap",
        "timeContext": {
          "durationMs": 604800000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "map",
        "mapSettings": {
          "locInfo": "CountryRegion",
          "locInfoColumn": "Country",
          "latitude": "Latitude",
          "longitude": "Longitude",
          "sizeSettings": "Attempts",
          "sizeAggregation": "Sum",
          "legendMetric": "Attempts",
          "legendAggregation": "Sum",
          "itemColorSettings": {
            "nodeColorField": "Attempts",
            "colorAggregation": "Sum",
            "type": "heatmap",
            "heatmapPalette": "greenRed"
          }
        },
        "crossComponentResources": [
          "/subscriptions/155337ea-51d8-4381-9a2b-501c19c5b0ca/resourcegroups/socrg/providers/microsoft.operationalinsights/workspaces/soc-wp"
        ]
      },
      "customWidth": "50",
      "name": "query - 2",
      "id": "bdf0d44a-664f-47b5-b545-8ed5a100c2f6"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let IpRegex = @\"\\b\\d{1,3}(\\.\\d{1,3}){3}\\b\";\nSyslog\n| where Facility == \"auth\" and SyslogMessage startswith \"Failed password for\"\n| extend SrcIP = extract(IpRegex, 0, SyslogMessage)\n| summarize Attempts = count() by SrcIP",
        "size": 0,
        "title": "Top IPs",
        "timeContext": {
          "durationMs": 604800000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "piechart",
        "crossComponentResources": [
          "/subscriptions/155337ea-51d8-4381-9a2b-501c19c5b0ca/resourcegroups/socrg/providers/microsoft.operationalinsights/workspaces/soc-wp"
        ]
      },
      "customWidth": "25",
      "name": "query - 6",
      "id": "77746488-27ff-4215-8844-ecfa83f23a90"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "Syslog\n| where Facility == \"auth\" and SyslogMessage startswith \"Failed password for\"\n| extend AttemptedUser = extract(@\"for (invalid user )?(\\S+)\", 2, SyslogMessage)\n| summarize Attempts = count() by AttemptedUser\n| top 5 by Attempts desc\n",
        "size": 0,
        "title": "Top 5 usernames attempted",
        "timeContext": {
          "durationMs": 604800000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "piechart",
        "crossComponentResources": [
          "/subscriptions/155337ea-51d8-4381-9a2b-501c19c5b0ca/resourcegroups/socrg/providers/microsoft.operationalinsights/workspaces/soc-wp"
        ]
      },
      "customWidth": "25",
      "name": "query - 5",
      "id": "247a24d7-c567-4f1f-92fa-c40b8e6c749b"
    }
  ],
  "isLocked": false,
  "fallbackResourceIds": [
    "/subscriptions/155337ea-51d8-4381-9a2b-501c19c5b0ca/resourcegroups/socrg/providers/microsoft.operationalinsights/workspaces/soc-wp"
  ],
  "fromTemplateId": "sentinel-UserWorkbook",
  "context": {
    "ownerId": "/subscriptions/155337ea-51d8-4381-9a2b-501c19c5b0ca/resourcegroups/socrg/providers/microsoft.operationalinsights/workspaces/soc-wp"
  }
}